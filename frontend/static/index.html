<!doctype html>
<html lang="">

<head>  
  <script src="bower_components/webcomponentsjs/webcomponents-lite.js"></script>

  <link rel="import" href="elements/elements.html">

  <link rel="import" href="elements/bet-box.html">
  <link rel="import" href="elements/country-box.html">

  <!-- Services -->
  <link rel="import" href="elements/country-service.html">
  <link rel="import" href="elements/user-service.html">
  <link rel="import" href="elements/match-service.html">

  <!-- Routing -->
  <link rel="import" href="elements/routing.html">

  <style>
  body{
    background-color: #F7F7F7;
  }
  .betsContainer{
    text-align: center;
  }
  .betBox{
    display: inline-block;
    margin: 10px 0px 0px 10px;
  }
  .login{
    display: inline-block;
    margin-left: auto;
    margin-right: 0;
  }
  .username{
    display: inline-block;
  }
  .check{
    position: fixed;
    right: 20px;
    bottom: 20px;
    background-color: #EC407A;
    --paper-fab-background: #EC407A;
  }
  .tabs{
    margin: 0;
    width: 500px;
    text-transform: uppercase;

  }
  .tab{
    text-decoration: none;
    color:white;
  }
  .ranksUser{
    margin-left: 10%;
    margin-right: 10%;
    padding: 10px;
    border-bottom: 1px solid black;
  }
  .ranks{
    margin-left: 10%;
    margin-right: 10%;
    padding: 10px;
    border-bottom: 1px solid black;
    text-align: center;
  }
  .country{
    display: inline-block;
    text-align: center;
    margin-right: 5px;
  }
  a{
    color: inherit;
  }
  .load{
    margin: 0;
    position: absolute;
    top: 50%;
    left: 50%;
    margin-right: -50%;
    transform: translate(-50%, -50%);
  }
  </style>
</head>

<body unresolved class="fullbleed layout vertical">
  <template is="dom-bind" id="app">
    <paper-header-panel main>
    <!-- Header toolbar -->
    <paper-toolbar>

    <paper-tabs class="tabs" attr-for-selected="data-route" selected="{{route}}" on-iron-select="onMenuSelect">
    <paper-tab link >
    <a data-route="bets" href="/" class="horizontal center-center layout tab">
      <span>Bets</span>
    </a>
  </paper-tab>
  <paper-tab link>
  <a data-route="userRanking" href="/userRanking" class="horizontal center-center layout tab">
    <span>User ranking</span>
  </a>
</paper-tab>
<paper-tab link>
<a data-route="allRanking" href="/allRanking" class="horizontal center-center layout tab">
  <span>All ranking</span>
</a>
</paper-tab>            
</paper-tabs>
<!-- show current account and login option -->  
<div class="login">
  <p class="username">Login</p>
  <a href="login.html" id="login"><paper-icon-button icon="account-circle" class="account"></paper-icon-button></a>
</div>

</paper-toolbar>

<!-- Header content -->
<!-- Pages of the website -->
<iron-pages attr-for-selected="data-route" selected="{{route}}">

<!-- 1) boxes containing the games -->
<match-service></match-service>
<country-service></country-service>
<user-service></user-service>


<section data-route="bets">
  <paper-spinner class="load load1" active></paper-spinner>

  <div class="betsContainer" vertical layout center>

  </div>        

  <paper-fab icon="check" class="check"></paper-fab>
  <paper-toast text="Bet for every game" id="notAll"></paper-toast>
</section>

<!-- 2) User ranking -->
<section data-route="userRanking">
  <paper-spinner class="load load2" active></paper-spinner>
  <div class="userRanking">
    <div class="ranksUser winner">
      <h3>Winner</h3>
      <div class="rank"></div>                          
    </div>

    <div class="ranksUser final">
      <h3>Final</h3>
      <div></div>
    </div>
    <div class="ranksUser semiFinals">
      <h3>Semi-finals</h3>
      <div></div>
    </div>
    <div class="ranksUser quarterFinals">
      <h3>Quarter-finals</h3>
      <div></div>
    </div>
    <div class="ranksUser roundOf16">
      <h3>Round of 16</h3>
      <div></div>
    </div>
  </div>

</section>

<!-- 3) All ranking -->
<section data-route="allRanking">
  <paper-spinner class="load load3" active></paper-spinner>
  <div class="ranks">
    <h3>1st</h3>
    <iron-image style="width:200px; height:150px;" sizing="cover" src="img/flags/fr.png"></iron-image>
    <p>France</p>
    <p>Pseudo A, Pseudo A, Pseudo A, Pseudo A, Pseudo A, Pseudo A, Pseudo A, Pseudo A,</p>         
  </div>

  <div class="ranks">
    <h3>2nd</h3>
    <iron-image style="width:150px; height:113px;" sizing="cover" src="img/flags/de.png"></iron-image>
    <p>Germany</p>
    <p>Pseudo A, Pseudo A, Pseudo A, Pseudo A, Pseudo A, Pseudo A, Pseudo A, Pseudo A,</p>         
  </div>
</section>


</iron-pages>
</paper-header-panel>  
</template>
</body>

</html>
<script>

var countryList = [];
var matchList = [];
var ranking;
var user;
var winners = []
var userService;
var countryService;
var matchService;
var nbBets = 8;

$(document).ready(function(){
  $(".check").hide();
  $(".userRanking").hide();

    //display session
    $(".username").text($.session.get("session"));
    
    userService = $("user-service").get(0);
    countryService = $("country-service").get(0);
    matchService = $("match-service").get(0);
    //load all apis
    loadApis().done(function(){
      //get countries and user
      $.when(getCountries(), getUserByPseudo()).done(function(resultCountries, resultUser){
        user = resultUser;
        countryList = resultCountries;
        createMatches();
        rankingDatastore();
      });
    });      

    //submit bets
    $(".check").click(function(){
      nbBets /= 2;
      createNewMatches(winners);      
    });

    $(".betsContainer").click(function(event){
      var button = $(event.target);
      if(button.is("paper-material")){
        winners = [];
        $("bet-box").each(function(){
          var result = $(this).get(0).winner;
          if(result != undefined){
            winners.push(result);  
          }        
        });
        if(winners.length == nbBets){
          $(".check").show();
        }
      }
    });

  });


  //functions


  function loadApis(){
    var deferred = $.Deferred();
    $.when(userService.load(), countryService.load(), matchService.load()).done(function(){
      console.log("all apis loaded");
      deferred.resolve();    
    });
    return deferred.promise();
  }

  function getCountries(){
    var deferred = $.Deferred();
    countryService.list().done(function(result){
      deferred.resolve(result);
    });
    return deferred.promise();
  }

  function createMatches(){
    $(".load1").hide();
    for(i = 0; i<countryList.countries.length; i=i+2){
      matchList.push({"uidCountryA" : countryList.countries[i].uid, "uidCountryB" : countryList.countries[i+1].uid, "uidUser" : user.uid, "round": 1});
      var betBox = document.createElement("bet-box");
      betBox.countryA = countryList.countries[i];
      betBox.countryB = countryList.countries[i+1];
      $(".betsContainer").append(betBox);
    }
  }

  function createNewMatches(winners){
    var round = matchList[matchList.length-1].round;
    $(".check").hide();
    setWinnersUid(winners);
    if(round == 4){
      $(".betsContainer").empty();
      submitRanking().done(function(){
        rankingLocal();
      });
    }
    else{
      $(".betsContainer").empty();
      for(i = 0; i<winners.length; i=i+2){
        matchList.push({"uidCountryA" : winners[i].uid, "uidCountryB" : winners[i+1].uid, "uidUser" : user.uid, "round": round+1});
        var betBox = document.createElement("bet-box");
        betBox.countryA = winners[i];
        betBox.countryB = winners[i+1];
        $(".betsContainer").append(betBox);
      }
    }    
  }

  function setWinnersUid(winners){
    var i;
    for(i = 0; i<winners.length; i++){
      var j;
      for(j = matchList.length-1; j>=0; j--){
        if(matchList[j].uidCountryA == winners[i].uid || matchList[j].uidCountryB == winners[i].uid){
          matchList[j].uidWinner = winners[i].uid;
        }
      }
    }
    
  }

  function rankingLocal(){
    var rankings = {};
    rankings.matchs = matchList;
    console.log(rankings);
    ranking(rankings);
  }

  function rankingDatastore(){
    getRanking().done(function(rankingResult){
      ranking(rankingResult);
    }); 
  }

  function ranking(ranking){
    $(".load2").show();
    $(".userRanking").hide();
    $(".ranksUser").each(function(){
      $(this).children("div").empty();
    });
    
    var length = ranking.matchs.length;
    var i; 
    for(i = 0; i<ranking.matchs.length; i++){
      match = ranking.matchs[i];
      if(user.uid == match.uidUser){

        var countryBox = document.createElement("country-box");
        var countryA = getCountryWithUid(match.uidCountryA);
        var countryB = getCountryWithUid(match.uidCountryB);
        countryBox.countryA = countryA;
        countryBox.countryB = countryB;

        if(match.round == 4){
          $(".final").children("div").append(countryBox);

          var winner = getCountryWithUid(match.uidWinner)
          var winnerFlag = $("<div class='country'><iron-image style='width:200px; height:150px;' sizing='cover' src=img/"+winner.urlflag+"></iron-image></div>");
          var winnerName = $("<p>"+winner.label+"</p>");
          $(".winner").children("div").append(winnerFlag);
          $(".country").append(winnerName);
        }
        else if(match.round == 1){
          $(".roundOf16").children("div").append(countryBox); 
        }
        else if(match.round == 2){
          $(".quarterFinals").children("div").append(countryBox); 
        }
        else if(match.round == 3){
          $(".semiFinals").children("div").append(countryBox); 
        }
      }
    }  
    $(".load2").hide();
    $(".userRanking").show();
}

function submitRanking(){
  var deferred = $.Deferred();
  console.log(matchList);
  matchService.submitRanking(matchList).done(function(result){
    console.log("OK");
    deferred.resolve(result);
  });
  return deferred.promise();
}

function getRanking(){
  var deferred = $.Deferred();
  matchService.list().done(function(result){
    console.log(result);
    deferred.resolve(result);
  });
  return deferred.promise();
}

function getCountryWithUid(uid){
  var i;
  for(i = 0; i<countryList.countries.length;i++){
    if(countryList.countries[i].uid == uid){
      return countryList.countries[i];
    }
  }
}

function getUserByPseudo(){
  var currentUser = $.session.get("session");
  var deferred = $.Deferred();
  if(currentUser != undefined){
    userService.getUserByPseudo({"pseudo" : currentUser}).done(function(res){
      if(res == null){
        deferred.resolve({uid : ""})
      }
      else{
        deferred.resolve(res);  
      }        
    });
  }
  else{
    deferred.resolve({uid : ""});
  }
  return deferred.promise();
}

</script>

